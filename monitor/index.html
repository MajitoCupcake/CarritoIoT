<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IoT Cart Manager ¬∑ Monitoreo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../assets/css/styles.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold fs-3" href="../">
      <i class="fas fa-robot text-primary me-2"></i>IoT Cart Manager
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-primary" href="../">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
      </a>
      <a class="btn btn-outline-primary" href="../control/">
        <i class="fas fa-gamepad me-1"></i>Control
      </a>
      <a class="btn btn-primary active" href="./">
        <i class="fas fa-satellite-dish me-1"></i>Monitoreo
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-primary mb-3">Centro de Monitoreo</h1>
    <p class="lead text-muted fs-4">Seguimiento en tiempo real de todos tus dispositivos</p>
  </div>

  <div class="row g-4">
    <!-- Secci√≥n de Dispositivos -->
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-microchip me-2"></i>Dispositivos Conectados
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3" id="devices-container">
            <div class="col-md-4">
              <div class="device-card online">
                <div class="device-icon">
                  <i class="fas fa-robot"></i>
                </div>
                <div class="device-info">
                  <h6 class="device-name">Majo - Principal</h6>
                  <span class="device-status online">En L√≠nea</span>
                  <span class="device-ip">IP: 18.207.21.168</span>
                  <span class="device-last-seen">√öltima vez: Ahora</span>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="device-card offline">
                <div class="device-icon">
                  <i class="fas fa-robot"></i>
                </div>
                <div class="device-info">
                  <h6 class="device-name">Backup Car</h6>
                  <span class="device-status offline">Desconectado</span>
                  <span class="device-ip">IP: No disponible</span>
                  <span class="device-last-seen">√öltima vez: 5 min ago</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WebSocket Log -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-broadcast-tower me-2"></i>WebSocket Log
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="log-enhanced" id="wslog"></div>
        </div>
      </div>
    </div>

    <!-- √öltimos Obst√°culos -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-exclamation-triangle me-2"></i>√öltimos 10 Obst√°culos
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tbl-obs">
              <thead class="table-light">
                <tr>
                  <th class="fs-6">Estado</th>
                  <th class="fs-6">Mensaje</th>
                  <th class="fs-6">Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- √öltimos Movimientos -->
  <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-success text-white">
      <h5 class="card-title mb-0 fs-4">
        <i class="fas fa-directions me-2"></i>√öltimos 10 Movimientos
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="tbl-moves">
          <thead class="table-light">
            <tr>
              <th class="fs-6">Movimiento</th>
              <th class="fs-6">Velocidad</th>
              <th class="fs-6">Comentario</th>
              <th class="fs-6">Timestamp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer mt-5 py-4 bg-light border-top">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="mb-0 fw-bold fs-5">
          <i class="fas fa-user-graduate me-2 text-primary"></i>
          Mary Jose Hern√°ndez Fern√°ndez
        </p>
        <p class="mb-0 text-muted fs-6">
          <i class="fas fa-laptop-code me-2"></i>
          Ingenier√≠a en Sistemas Computacionales
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <a href="https://www.linkedin.com/in/mary-jose-hern√°ndez-fern√°ndez" 
           class="btn btn-outline-primary btn-lg" target="_blank">
          <i class="fab fa-linkedin me-2"></i>
          Conectar en LinkedIn
        </a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
import "../assets/js/config.js";
import { getMovements, getObstacles } from "../assets/js/api.js";
import { connectWS, onWSMessage, sendWSMessage } from "../assets/js/ws.js";

const wslog = document.getElementById("wslog");

function addWS(txt) {
    const stamp = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.className = "log-line log-info";
    div.innerHTML = `
        <span class="log-time">[${stamp}]</span>
        <span class="log-message">${typeof txt === 'string' ? txt : JSON.stringify(txt)}</span>
        <i class="fas fa-broadcast-tower ms-2"></i>
    `;
    wslog.appendChild(div);
    wslog.scrollTop = log.scrollHeight;
}

// Funci√≥n para actualizar la tabla de movimientos
function updateMovementsTable(movements) {
    const tbM = document.querySelector("#tbl-moves tbody");
    tbM.innerHTML = "";
    
    if (movements && movements.length > 0) {
        movements.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge movement-badge">${r.movement || r.status || "‚Äî"}</span></td>
                <td class="fw-bold">${r.speed != null ? r.speed + "%" : "‚Äî"}</td>
                <td>${r.comment || ""}</td>
                <td class="text-muted small">${r.timestamp || r.time || ""}</td>
            `;
            tbM.appendChild(tr);
        });
    } else {
        tbM.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay movimientos registrados
                </td>
            </tr>
        `;
    }
}

// Funci√≥n para actualizar la tabla de obst√°culos
function updateObstaclesTable(obstacles) {
    const tbO = document.querySelector("#tbl-obs tbody");
    tbO.innerHTML = "";
    
    if (obstacles && obstacles.length > 0) {
        obstacles.forEach(r => {
            const status = r.status || r.estado || "‚Äî";
            const distance = r.distance_cm || r.distance;
            const message = r.message || r.mensaje || (status === "OBSTACULO" ? `Obst√°culo a ${distance || "?"}cm` : "Camino despejado");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge ${status === 'OBSTACULO' ? 'bg-danger' : 'bg-success'}">${status}</span></td>
                <td>${message}</td>
                <td class="text-muted small">${r.timestamp || r.time || ""}</td>
            `;
            tbO.appendChild(tr);
        });
    } else {
        tbO.innerHTML = `
            <tr>
                <td colspan="3" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay datos de obst√°culos
                </td>
            </tr>
        `;
    }
}

// WebSocket para NOTIFICACIONES PUSH
connectWS();
onWSMessage(msg => {
    console.log("üì® Notificaci√≥n WebSocket recibida:", msg);
    addWS(msg);
    
    if (msg.type === "new_movement") {
        // ACTUALIZACI√ìN INSTANT√ÅNEA - Agregar nuevo movimiento a la tabla
        const currentMovements = Array.from(document.querySelectorAll("#tbl-moves tbody tr"));
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td><span class="badge movement-badge">${msg.movement.movement}</span></td>
            <td class="fw-bold">${msg.movement.speed}%</td>
            <td>${msg.movement.comment}</td>
            <td class="text-muted small">${msg.movement.timestamp}</td>
        `;
        document.querySelector("#tbl-moves tbody").insertBefore(newRow, document.querySelector("#tbl-moves tbody").firstChild);
        
        // Limitar a 10 filas
        if (currentMovements.length >= 10) {
            document.querySelector("#tbl-moves tbody").lastChild.remove();
        }
        
        addWS(`üöÄ NUEVO MOVIMIENTO: ${msg.movement.movement}`);
        
    } else if (msg.type === "new_obstacle") {
        // ACTUALIZACI√ìN INSTANT√ÅNEA - Agregar nuevo obst√°culo a la tabla
        const currentObstacles = Array.from(document.querySelectorAll("#tbl-obs tbody tr"));
        const newRow = document.createElement("tr");
        newRow.innerHTML = `
            <td><span class="badge ${msg.obstacle.status === 'OBSTACULO' ? 'bg-danger' : 'bg-success'}">${msg.obstacle.status}</span></td>
            <td>${msg.obstacle.message}</td>
            <td class="text-muted small">${msg.obstacle.timestamp}</td>
        `;
        document.querySelector("#tbl-obs tbody").insertBefore(newRow, document.querySelector("#tbl-obs tbody").firstChild);
        
        // Limitar a 10 filas
        if (currentObstacles.length >= 10) {
            document.querySelector("#tbl-obs tbody").lastChild.remove();
        }
        
        addWS(`üöß NUEVO OBST√ÅCULO: ${msg.obstacle.status}`);
    }
});

// Cargar datos iniciales
async function loadTables() {
    try {
        const [moves, obs] = await Promise.all([getMovements(), getObstacles()]);
        updateMovementsTable(moves);
        updateObstaclesTable(obs);
        addWS("‚úÖ Datos iniciales cargados");
    } catch(e) {
        console.error("Error cargando tablas:", e);
        addWS("‚ùå Error cargando datos iniciales: " + e.message);
    }
}

// Cargar inmediatamente
loadTables();

// Mantener polling como respaldo (pero ahora las actualizaciones ser√°n instant√°neas via WebSocket)
setInterval(loadTables, 10000); // Reducido a 10 segundos ya que las actualizaciones principales son via push

console.log("üîî Monitor configurado para notificaciones push");
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>