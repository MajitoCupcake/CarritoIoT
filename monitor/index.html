<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>IoT Car · Monitoreo</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">

    <style>
        /* ESTILO FULL SCREEN */
        body, html { height: 100vh; margin: 0; overflow: hidden; background-color: #e9ecef; font-family: 'Segoe UI', sans-serif; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .content-area { flex-grow: 1; overflow: hidden; padding: 15px; }
        
        /* GRID MONITOR (2 Columnas) */
        .monitor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 100%;
        }

        .panel {
            background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden; height: 100%;
        }
        .panel-header { padding: 10px 15px; font-weight: bold; color: white; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { padding: 0; flex-grow: 1; overflow-y: auto; }
        
        .table-sticky thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; border-bottom: 2px solid #dee2e6; }
        .table td { vertical-align: middle; font-size: 0.9rem; }

        .footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 15px 0; font-size: 0.9rem; }

        @media (max-width: 768px) {
            body, html { overflow: auto; height: auto; }
            .monitor-grid { display: flex; flex-direction: column; height: auto; }
            .panel { height: 400px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <nav class="navbar navbar-light bg-white border-bottom">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3" href="../">
          <i class="fas fa-robot text-primary me-2"></i>IoT Car Manager
        </a>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-outline-primary" href="../"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
          <a class="btn btn-outline-primary" href="../control/"><i class="fas fa-gamepad me-1"></i>Control</a>
          <a class="btn btn-primary active" href="#"><i class="fas fa-satellite-dish me-1"></i>Monitoreo</a>
          <span id="ws-status" class="badge bg-danger ms-2">Desconectado</span>
        </div>
      </div>
    </nav>

    <div class="content-area">
        <div class="monitor-grid">
            
            <div class="panel">
                <div class="panel-header bg-success">
                    <span><i class="fas fa-history me-2"></i>Últimos 10 Movimientos</span>
                    <span class="badge bg-white text-success" id="count-moves">0</span>
                </div>
                <div class="panel-body">
                    <table class="table table-hover table-striped table-sticky mb-0 table-sm">
                        <thead><tr><th>Acción</th><th>Vel</th><th>Comentario</th><th>Hora</th></tr></thead>
                        <tbody id="tbl-moves"><tr><td colspan="4" class="text-center p-3">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header bg-danger">
                    <span><i class="fas fa-exclamation-triangle me-2"></i>Últimos 10 Obstáculos</span>
                    <span class="badge bg-white text-danger" id="count-obs">0</span>
                </div>
                <div class="panel-body">
                    <table class="table table-hover table-striped table-sticky mb-0 table-sm">
                        <thead><tr><th>Estado</th><th>Distancia</th><th>Hora</th></tr></thead>
                        <tbody id="tbl-obs"><tr><td colspan="3" class="text-center p-3">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <p class="mb-0 fw-bold"><i class="fas fa-user-graduate me-2 text-primary"></i>Mary Jose Hernández Fernández</p>
            <p class="mb-0 text-muted small"><i class="fas fa-laptop-code me-2"></i>Ingeniería en Sistemas Computacionales</p>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="#" class="btn btn-sm btn-outline-primary"><i class="fab fa-linkedin me-2"></i>LinkedIn</a>
          </div>
        </div>
      </div>
    </footer>

</div>

<script>
    const HOST_IP = "18.207.21.168"; 
    const WS_PORT = "5500";
    const WS_URL = `ws://${HOST_IP}:${WS_PORT}/api/ws`; 
    const API_URL = `http://${HOST_IP}:${WS_PORT}/api`;

    // Renderizadores de Fila HTML
    function renderRowMove(m) {
        return `<tr>
            <td><span class="badge bg-primary">${m.movement_code}</span></td>
            <td>${m.speed_pct}%</td>
            <td class="small text-muted text-truncate" style="max-width: 150px;">${m.comment}</td>
            <td class="small">${new Date(m.event_time).toLocaleTimeString()}</td>
        </tr>`;
    }

    function renderRowObs(o) {
        const color = o.status_code === "OBSTACULO" ? "bg-danger" : "bg-success";
        return `<tr>
            <td><span class="badge ${color}">${o.status_code}</span></td>
            <td>${o.distance_cm} cm</td>
            <td class="small">${new Date(o.event_time).toLocaleTimeString()}</td>
        </tr>`;
    }

    // Carga inicial (Limitada a 10)
    async function loadHistory() {
        try {
            const [resM, resO] = await Promise.all([
                fetch(`${API_URL}/telemetry/movements`),
                fetch(`${API_URL}/telemetry/obstacles`)
            ]);
            
            const mFull = await resM.json();
            const oFull = await resO.json();

            // AQUÍ ESTÁ LA MAGIA: .slice(0, 10) toma solo los primeros 10
            const m = mFull.slice(0, 10);
            const o = oFull.slice(0, 10);

            document.getElementById("count-moves").innerText = mFull.length; // Muestra total real en el badge
            document.getElementById("count-obs").innerText = oFull.length;

            document.getElementById("tbl-moves").innerHTML = m.map(renderRowMove).join("");
            document.getElementById("tbl-obs").innerHTML = o.map(renderRowObs).join("");

        } catch(e) { console.error(e); }
    }

    // WebSocket (Mantiene la lista en 10)
    function connect() {
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => {
            document.getElementById("ws-status").className = "badge bg-success ms-2";
            document.getElementById("ws-status").innerText = "Online";
            loadHistory();
        };
        ws.onclose = () => {
            document.getElementById("ws-status").className = "badge bg-danger ms-2";
            document.getElementById("ws-status").innerText = "Offline";
            setTimeout(connect, 3000);
        };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            
            if(msg.type === "new_movement") {
                const tbody = document.getElementById("tbl-moves");
                tbody.insertAdjacentHTML('afterbegin', renderRowMove(msg.movement));
                // Si hay más de 10, borramos el último
                if (tbody.children.length > 10) tbody.removeChild(tbody.lastElementChild);
            }
            
            if(msg.type === "new_obstacle") {
                const tbody = document.getElementById("tbl-obs");
                tbody.insertAdjacentHTML('afterbegin', renderRowObs(msg.obstacle));
                // Si hay más de 10, borramos el último
                if (tbody.children.length > 10) tbody.removeChild(tbody.lastElementChild);
            }
        };
    }

    connect();
</script>
</body>
</html>