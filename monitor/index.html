<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IoT Cart Manager · Monitoreo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="../assets/css/styles.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold fs-3" href="../">
      <i class="fas fa-robot text-primary me-2"></i>IoT Cart Manager
    </a>
    <div class="d-flex align-items-center gap-2">
      <button id="themeBtn" class="theme-toggle">
        <i class="fas fa-moon"></i>
      </button>
      <a class="btn btn-outline-primary" href="../">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
      </a>
      <a class="btn btn-outline-primary" href="../control/">
        <i class="fas fa-gamepad me-1"></i>Control
      </a>
      <a class="btn btn-primary active" href="./">
        <i class="fas fa-satellite-dish me-1"></i>Monitoreo
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-gradient mb-3">Centro de Monitoreo</h1>
    <p class="lead text-muted fs-4">Seguimiento en tiempo real de todos tus dispositivos</p>
  </div>

  <div class="row g-4">
    <!-- Sección de Dispositivos -->
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-microchip me-2"></i>Dispositivos Conectados
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3" id="devices-container">
            <div class="col-md-4">
              <div class="device-card online">
                <div class="device-icon">
                  <i class="fas fa-robot"></i>
                </div>
                <div class="device-info">
                  <h6 class="device-name">Majo - Principal</h6>
                  <span class="device-status online">En Línea</span>
                  <span class="device-ip">IP: 18.207.21.168</span>
                  <span class="device-last-seen">Última vez: Ahora</span>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="device-card offline">
                <div class="device-icon">
                  <i class="fas fa-robot"></i>
                </div>
                <div class="device-info">
                  <h6 class="device-name">Backup Car</h6>
                  <span class="device-status offline">Desconectado</span>
                  <span class="device-ip">IP: No disponible</span>
                  <span class="device-last-seen">Última vez: 5 min ago</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- WebSocket Log -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-broadcast-tower me-2"></i>WebSocket Log
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="log-enhanced" id="wslog"></div>
        </div>
      </div>
    </div>

    <!-- Últimos Obstáculos -->
    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-exclamation-triangle me-2"></i>Últimos 10 Obstáculos
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tbl-obs">
              <thead class="table-light">
                <tr>
                  <th class="fs-6">Estado</th>
                  <th class="fs-6">Mensaje</th>
                  <th class="fs-6">Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Últimos Movimientos -->
  <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-success text-white">
      <h5 class="card-title mb-0 fs-4">
        <i class="fas fa-directions me-2"></i>Últimos 10 Movimientos
      </h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="tbl-moves">
          <thead class="table-light">
            <tr>
              <th class="fs-6">Movimiento</th>
              <th class="fs-6">Velocidad</th>
              <th class="fs-6">Comentario</th>
              <th class="fs-6">Timestamp</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer mt-5 py-4 bg-light border-top">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="mb-0 fw-bold fs-5">
          <i class="fas fa-user-graduate me-2 text-primary"></i>
          Mary Jose Hernández Fernández
        </p>
        <p class="mb-0 text-muted fs-6">
          <i class="fas fa-laptop-code me-2"></i>
          Ingeniería en Sistemas Computacionales
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <a href="https://www.linkedin.com/in/mary-jose-hernández-fernández" 
           class="btn btn-outline-primary btn-lg" target="_blank">
          <i class="fab fa-linkedin me-2"></i>
          Conectar en LinkedIn
        </a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
import "../assets/js/config.js";
import { getMovements, getObstacles } from "../assets/js/api.js";
import { connectWS, onWSMessage } from "../assets/js/ws.js";

const wslog = document.getElementById("wslog");

function addWS(txt) {
  const stamp = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = "log-line log-info";
  div.innerHTML = `
    <span class="log-time">[${stamp}]</span>
    <span class="log-message">${txt.replaceAll("<","&lt;").replaceAll(">","&gt;")}</span>
    <i class="fas fa-broadcast-tower ms-2"></i>
  `;
  wslog.appendChild(div);
  wslog.scrollTop = wslog.scrollHeight;
}

// WebSocket
connectWS();
onWSMessage(msg => addWS(JSON.stringify(msg)));

// Cargar tablas
async function loadTables() {
  try {
    const [moves, obs] = await Promise.all([getMovements(), getObstacles()]);
    
    // Movimientos
    const tbM = document.querySelector("#tbl-moves tbody");
    tbM.innerHTML = "";
    (moves || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="badge movement-badge">${r.movement || r.status || "—"}</span></td>
        <td class="fw-bold">${r.speed != null ? r.speed + "%" : "—"}</td>
        <td>${r.comment || ""}</td>
        <td class="text-muted small">${r.timestamp || r.time || ""}</td>
      `;
      tbM.appendChild(tr);
    });

    // Obstáculos
    const tbO = document.querySelector("#tbl-obs tbody");
    tbO.innerHTML = "";
    (obs || []).forEach(r => {
      const status = r.status || r.estado || "—";
      const message = r.message || r.mensaje || (status === "OBSTACULO" ? `Obstáculo a ${r.distance_cm || r.distance || "?"}cm` : "Camino despejado");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="badge ${status === 'OBSTACULO' ? 'bg-danger' : 'bg-success'}">${status}</span></td>
        <td>${message}</td>
        <td class="text-muted small">${r.timestamp || r.time || ""}</td>
      `;
      tbO.appendChild(tr);
    });
  } catch(e) {
    addWS("Error cargando tablas: " + e);
  }
}

loadTables();
setInterval(loadTables, 6000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>