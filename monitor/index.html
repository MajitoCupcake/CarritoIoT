<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>IoT Cart Manager ¬∑ Monitoreo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold fs-3" href="../">
      <i class="fas fa-robot text-primary me-2"></i>IoT Cart Manager
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-primary" href="../">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
      </a>
      <a class="btn btn-outline-primary" href="../control/">
        <i class="fas fa-gamepad me-1"></i>Control
      </a>
      <a class="btn btn-primary active" href="./">
        <i class="fas fa-satellite-dish me-1"></i>Monitoreo
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-primary mb-3">Centro de Monitoreo (PUSH)</h1>
    <p class="lead text-muted fs-4">Seguimiento en tiempo real de todos tus dispositivos</p>
  </div>

  <div class="row g-4">
    <div class="col-12">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-broadcast-tower me-2"></i>WebSocket Log
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="log-enhanced" id="wslog"></div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-directions me-2"></i>√öltimos 10 Movimientos
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tbl-moves">
              <thead class="table-light">
                <tr>
                  <th class="fs-6">Movimiento</th>
                  <th class="fs-6">Velocidad</th>
                  <th class="fs-6">Comentario</th>
                  <th class="fs-6">Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-exclamation-triangle me-2"></i>√öltimos 10 Obst√°culos
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tbl-obs">
              <thead class="table-light">
                <tr>
                  <th class="fs-6">Estado</th>
                  <th class="fs-6">Mensaje</th>
                  <th class="fs-6">Timestamp</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="footer mt-5 py-4 bg-light border-top">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="mb-0 fw-bold fs-5">
          <i class="fas fa-user-graduate me-2 text-primary"></i>
          Mary Jose Hern√°ndez Fern√°ndez
        </p>
        <p class="mb-0 text-muted fs-6">
          <i class="fas fa-laptop-code me-2"></i>
          Ingenier√≠a en Sistemas Computacionales
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <a href="https://www.linkedin.com/in/mary-jose-hern√°ndez-fern√°ndez" 
           class="btn btn-outline-primary btn-lg" target="_blank">
          <i class="fab fa-linkedin me-2"></i>
          Conectar en LinkedIn
        </a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
  import { API_BASE, WS_URL } from "../assets/js/config.js";
  import { getMovements, getObstacles } from "../assets/js/api.js";
  import { connectWS, onWSMessage, sendWSMessage } from "../assets/js/ws.js";

  const wslog = document.getElementById("wslog");

  function addWS(txt) {
    const stamp = new Date().toLocaleTimeString();
    const div = document.createElement("div");
    div.className = "log-line log-info";
    div.innerHTML = `
        <span class="log-time">[${stamp}]</span>
        <span class="log-message">${typeof txt === 'string' ? txt : JSON.stringify(txt)}</span>
        <i class="fas fa-broadcast-tower ms-2"></i>
    `;
    wslog.appendChild(div);
    wslog.scrollTop = wslog.scrollHeight;
  }

  // --- FUNCI√ìN CORREGIDA (updateMovementsTable) ---
  function updateMovementsTable(movements) {
    const tbM = document.querySelector("#tbl-moves tbody");
    tbM.innerHTML = "";
    
    if (movements && movements.length > 0) {
        const lastMovements = movements.slice(0, 10);
        lastMovements.forEach(r => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge movement-badge">${r.movement_code || "‚Äî"}</span></td>
                <td class="fw-bold">${r.speed_pct != null ? r.speed_pct + "%" : "‚Äî"}</td>
                <td>${r.comment || ""}</td>
                <td class="text-muted small">${r.event_time || "‚Äî"}</td>
            `;
            tbM.appendChild(tr);
        });
    } else {
        tbM.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3"><i class="fas fa-info-circle me-2"></i>No hay movimientos registrados</td></tr>`;
    }
  }

  // --- FUNCI√ìN CORREGIDA (updateObstaclesTable) ---
  function updateObstaclesTable(obstacles) {
    const tbO = document.querySelector("#tbl-obs tbody");
    tbO.innerHTML = "";
    
    if (obstacles && obstacles.length > 0) {
        const lastObstacles = obstacles.slice(0, 10);
        lastObstacles.forEach(r => {
            const status = r.status_code || "‚Äî"; // Corregido de 'status'
            const distance = r.distance_cm || "?";
            const message = (status === "OBSTACULO" ? `Obst√°culo a ${distance}cm` : "Camino despejado");
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge ${status === 'OBSTACULO' ? 'bg-danger' : 'bg-success'}">${status}</span></td>
                <td>${message}</td>
                <td class="text-muted small">${r.event_time || "‚Äî"}</td>
            `;
            tbO.appendChild(tr);
        });
    } else {
        tbO.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-3"><i class="fas fa-info-circle me-2"></i>No hay datos de obst√°culos</td></tr>`;
    }
  }

  // --- L√ìGICA WEBSOCKET CORREGIDA ---
  connectWS();
  onWSMessage(async (msg) => {
    console.log("üì® Notificaci√≥n PUSH recibida:", msg);
    
    if (msg.type === "connection") {
        addWS("üîå Conectado al sistema - Cargando datos iniciales...");
        try {
            const [movements, obstacles] = await Promise.all([
                getMovements(),
                getObstacles()
            ]);
            updateMovementsTable(movements);
            updateObstaclesTable(obstacles);
            addWS(`‚úÖ Datos iniciales cargados: ${movements?.length || 0} movimientos, ${obstacles?.length || 0} obst√°culos`);
        } catch (error) {
            addWS("‚ùå Error cargando datos iniciales");
        }
    }
    else if (msg.type === "new_movement") {
        const newRow = document.createElement("tr");
        // CORREGIDO: Usar los nombres de columna de la DB
        newRow.innerHTML = `
            <td><span class="badge movement-badge">${msg.movement.movement_code}</span></td>
            <td class="fw-bold">${msg.movement.speed_pct}%</td>
            <td>${msg.movement.comment}</td>
            <td class="text-muted small">${msg.movement.event_time}</td>
        `;
        const tbody = document.querySelector("#tbl-moves tbody");
        tbody.insertBefore(newRow, tbody.firstChild);
        const rows = tbody.querySelectorAll("tr");
        if (rows.length > 10) tbody.removeChild(rows[rows.length - 1]);
        addWS(`üöÄ MOVIMIENTO PUSH: ${msg.movement.movement_code}`);
    } 
    else if (msg.type === "new_obstacle") {
        const newRow = document.createElement("tr");
        // CORREGIDO: Usar los nombres de columna de la DB
        const status = msg.obstacle.status_code;
        const distance = msg.obstacle.distance_cm;
        newRow.innerHTML = `
            <td><span class="badge ${status === 'OBSTACULO' ? 'bg-danger' : 'bg-success'}">${status}</span></td>
            <td>${status === 'OBSTACULO' ? `Obst√°culo a ${distance}cm` : 'Camino despejado'}</td>
            <td class="text-muted small">${msg.obstacle.event_time}</td>
        `;
        const tbody = document.querySelector("#tbl-obs tbody");
        tbody.insertBefore(newRow, tbody.firstChild);
        const rows = tbody.querySelectorAll("tr");
        if (rows.length > 10) tbody.removeChild(rows[rows.length - 1]);
        addWS(`üöß OBST√ÅCULO PUSH: ${status}`);
    } 
    else {
        addWS(msg);
    }
  });

  console.log("üîî Monitor configurado - Solo PUSH activo");
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>