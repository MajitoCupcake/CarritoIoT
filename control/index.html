<<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Majo IoT Car - Panel Completo</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            text-align: center;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; }
        
        /* Contenedor Principal */
        .main-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        /* Estado de Conexi√≥n */
        .status-bar {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
            background-color: #eee;
        }
        .connected { color: #27ae60; background-color: #d5f5e3; }
        .disconnected { color: #c0392b; background-color: #fadbd8; }

        /* --- SECCI√ìN 1: CONTROL MANUAL --- */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 0 auto 20px auto;
        }

        .btn-dir {
            background-color: #e0e0e0;
            border: none;
            border-radius: 15px;
            padding: 20px 0;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-dir:active { transform: scale(0.95); }
        .btn-dir:hover { background-color: #d0d0d0; }

        .btn-stop { background-color: #e74c3c; color: white; font-size: 30px; }
        .btn-stop:hover { background-color: #c0392b; }

        .giros-extra {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .btn-360 {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            background-color: #34495e;
            color: white;
            cursor: pointer;
        }

        /* --- SECCI√ìN 2: VELOCIDAD --- */
        .speed-section {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            background-color: #fafafa;
        }
        .btn-vel {
            padding: 10px 15px;
            margin: 0 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: opacity 0.2s;
        }
        .btn-vel:hover { opacity: 0.8; }
        .vel-low { background-color: #8bc34a; }
        .vel-med { background-color: #f39c12; }
        .vel-high { background-color: #3498db; }

        /* --- SECCI√ìN 3: CREADOR DE SECUENCIAS --- */
        .sequence-section {
            border-top: 3px solid #eee;
            padding-top: 20px;
            text-align: left;
        }
        .form-group { margin-bottom: 10px; }
        input, select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        .btn-action {
            width: 100%;
            padding: 12px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
        }
        .step-list {
            background: #f9f9f9;
            border: 1px solid #ddd;
            min-height: 50px;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
        }
        .step-item {
            display: inline-block;
            background: #ddd;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="main-container">
    <h1>üöó Majo IoT Car</h1>
    
    <div id="status" class="status-bar disconnected">üî¥ Desconectado</div>

    <div class="control-grid">
        <button class="btn-dir" onclick="enviarComando('ADELANTE_IZQUIERDA')">‚ÜñÔ∏è</button>
        <button class="btn-dir" onclick="enviarComando('ADELANTE')">‚¨ÜÔ∏è</button>
        <button class="btn-dir" onclick="enviarComando('ADELANTE_DERECHA')">‚ÜóÔ∏è</button>
        
        <button class="btn-dir" onclick="enviarComando('GIRO_90_IZQUIERDA')">‚¨ÖÔ∏è</button>
        <button class="btn-dir btn-stop" onclick="enviarComando('DETENER')">üõë</button>
        <button class="btn-dir" onclick="enviarComando('GIRO_90_DERECHA')">‚û°Ô∏è</button>
        
        <button class="btn-dir" onclick="enviarComando('ATRAS_IZQUIERDA')">‚ÜôÔ∏è</button>
        <button class="btn-dir" onclick="enviarComando('ATRAS')">‚¨áÔ∏è</button>
        <button class="btn-dir" onclick="enviarComando('ATRAS_DERECHA')">‚ÜòÔ∏è</button>
    </div>

    <div class="giros-extra">
        <button class="btn-360" onclick="enviarComando('GIRO_360_IZQUIERDA')">üîÑ 360¬∞ I</button>
        <button class="btn-360" onclick="enviarComando('GIRO_360_DERECHA')">üîÑ 360¬∞ D</button>
    </div>

    <div class="speed-section">
        <h3>‚ö° Velocidad</h3>
        <button class="btn-vel vel-low" onclick="setVelocidad(40)">üê¢ Baja</button>
        <button class="btn-vel vel-med" onclick="setVelocidad(60)">üö∂ Media</button>
        <button class="btn-vel vel-high" onclick="setVelocidad(100)">üêá Alta</button>
        
        <p style="margin-top:10px;">Modo: <strong id="texto-velocidad" style="color: #f39c12;">MEDIA (60%)</strong></p>
    </div>

    <div class="sequence-section">
        <h3>üé¨ Crear Secuencia</h3>
        
        <div class="form-group">
            <input type="text" id="secuenciaNombre" placeholder="Nombre de la secuencia (ej: Patrulla)">
        </div>
        
        <div class="form-group">
            <select id="pasoSelect">
                <option value="ADELANTE">Adelante</option>
                <option value="ATRAS">Atr√°s</option>
                <option value="GIRO_90_DERECHA">Giro 90¬∞ Derecha</option>
                <option value="GIRO_90_IZQUIERDA">Giro 90¬∞ Izquierda</option>
                <option value="GIRO_360_DERECHA">Giro 360¬∞</option>
                <option value="obstacle">Detectar Obst√°culo</option>
            </select>
        </div>

        <button onclick="agregarPaso()" style="background:#34495e; color:white; padding:8px; width:100%; border:none; border-radius:5px; cursor:pointer;">‚ûï Agregar Paso</button>

        <div id="listaPasos" class="step-list">
            <span style="color:#999; font-size:12px;">(Sin pasos agregados)</span>
        </div>

        <button class="btn-action" onclick="guardarSecuenciaEnBD()">üíæ GUARDAR SECUENCIA</button>
    </div>

</div>

<script>
    // ---------------- CONFIGURACI√ìN ----------------
    // REEMPLAZA ESTO CON LA IP DE TU EC2 / PYTHON
    const HOST_IP = "18.207.21.168"; 
    const WS_PORT = "5500";
    
    // URLs
    const WS_URL = `ws://${HOST_IP}:${WS_PORT}/ws`; // OJO: Si es /api/ws c√°mbialo aqu√≠
    const API_URL = `http://${HOST_IP}:${WS_PORT}/api/sequences`;

    let socket;
    let velocidadActual = 60; // Valor por defecto
    let pasosActuales = [];   // Lista temporal de pasos para la secuencia

    // ---------------- 1. WEBSOCKET ----------------
    function conectarWebSocket() {
        console.log("Intentando conectar a:", WS_URL);
        socket = new WebSocket(WS_URL);

        socket.onopen = function() {
            document.getElementById("status").innerText = "üü¢ Conectado";
            document.getElementById("status").className = "status-bar connected";
            console.log("WS Conectado");
        };

        socket.onclose = function() {
            document.getElementById("status").innerText = "üî¥ Desconectado";
            document.getElementById("status").className = "status-bar disconnected";
            console.log("WS Cerrado. Reintentando...");
            setTimeout(conectarWebSocket, 3000);
        };

        socket.onerror = function(error) {
            console.error("WS Error:", error);
        };
    }

    // ---------------- 2. CONTROL MANUAL Y VELOCIDAD ----------------
    function setVelocidad(porcentaje) {
        velocidadActual = porcentaje;
        
        let texto = "MEDIA";
        let color = "#f39c12";
        
        if (porcentaje <= 45) { texto = "BAJA"; color = "#8bc34a"; }
        if (porcentaje >= 80) { texto = "ALTA"; color = "#3498db"; }

        const label = document.getElementById("texto-velocidad");
        label.innerText = `${texto} (${porcentaje}%)`;
        label.style.color = color;
    }

    function enviarComando(codigo) {
        if (!socket || socket.readyState !== WebSocket.OPEN) {
            alert("‚ö†Ô∏è No est√°s conectado al carrito.");
            return;
        }

        const payload = {
            "device_id": 1,
            "movement_code": codigo,
            "speed_pct": velocidadActual // ¬°Aqu√≠ se va la velocidad!
        };

        socket.send(JSON.stringify({
            "type": "new_movement",
            "movement": payload
        }));
        console.log(`Enviado: ${codigo} a ${velocidadActual}%`);
    }

    // ---------------- 3. GESTI√ìN DE SECUENCIAS ----------------
    function agregarPaso() {
        const select = document.getElementById("pasoSelect");
        const pasoCodigo = select.value;
        const pasoTexto = select.options[select.selectedIndex].text;

        pasosActuales.push(pasoCodigo);
        actualizarVisualizacionPasos();
    }

    function actualizarVisualizacionPasos() {
        const contenedor = document.getElementById("listaPasos");
        contenedor.innerHTML = ""; // Limpiar

        if (pasosActuales.length === 0) {
            contenedor.innerHTML = '<span style="color:#999; font-size:12px;">(Sin pasos agregados)</span>';
            return;
        }

        pasosActuales.forEach((paso, index) => {
            const div = document.createElement("span");
            div.className = "step-item";
            div.innerText = `${index + 1}. ${paso}`;
            contenedor.appendChild(div);
        });
    }

    function guardarSecuenciaEnBD() {
        const nombre = document.getElementById("secuenciaNombre").value;
        
        if (!nombre || pasosActuales.length === 0) {
            alert("‚ùå Escribe un nombre y agrega al menos un paso.");
            return;
        }

        // Enviar a la API (Python)
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: nombre,
                steps: pasosActuales
            })
        })
        .then(response => {
            if(response.ok) return response.json();
            throw new Error("Error en la petici√≥n");
        })
        .then(data => {
            alert("‚úÖ Secuencia Guardada Exitosamente");
            pasosActuales = [];
            document.getElementById("secuenciaNombre").value = "";
            actualizarVisualizacionPasos();
        })
        .catch(error => {
            console.error(error);
            alert("‚ùå Error al guardar (Revisa la consola / Mixed Content)");
        });
    }

    // INICIAR
    conectarWebSocket();

</script>

</body>
</html>