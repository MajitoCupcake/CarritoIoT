<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>IoT Car Manager ¬∑ Control</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">

    <style>
        /* --- ESTRUCTURA DE PANTALLA (Layout Flex) --- */
        body, html { height: 100vh; margin: 0; overflow: hidden; background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* Navbar y Footer fijos */
        .navbar { height: 60px; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; }
        .footer { height: 60px; background: #f8f9fa; border-top: 1px solid #ddd; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }

        /* √Årea central que ocupa el resto del espacio */
        .content-area { 
            flex-grow: 1; 
            padding: 15px; 
            overflow: hidden; /* El scroll lo manejan los paneles internos */
            height: calc(100vh - 120px); /* Total - Nav - Footer */
        }

        /* GRID DE 3 COLUMNAS */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 320px 1fr 350px; /* Izquierda Fija | Centro Flexible | Derecha Fija */
            gap: 15px;
            height: 100%;
        }

        /* ESTILO DE PANELES (TARJETAS) */
        .panel {
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            height: 100%; 
            border: 1px solid #e9ecef;
        }
        
        .panel-header { 
            padding: 12px 15px; 
            background: #f8f9fa; 
            border-bottom: 1px solid #eee; 
            font-weight: bold; 
            color: #495057; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0;
        }
        
        .panel-body { 
            padding: 15px; 
            overflow-y: auto; 
            flex-grow: 1; 
            position: relative; /* Para posicionar elementos absolutos si hace falta */
        }

        /* --- COLUMNA 1: JOYSTICK Y VELOCIDAD --- */
        .drive-pad-enhanced { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; max-width: 240px; margin: 0 auto; }
        .drive-btn { height: 65px; border-radius: 12px; font-size: 24px; border: none; background: #f1f3f5; color: #333; transition: 0.1s; box-shadow: 0 3px 0 #dee2e6; }
        .drive-btn:active { transform: translateY(3px); box-shadow: none; }
        
        .drive-btn-corner { background: #9c27b0 !important; color: white !important; box-shadow: 0 3px 0 #7b1fa2; }
        .drive-btn-stop { background: #dc3545 !important; color: white !important; font-size: 30px; box-shadow: 0 3px 0 #b02a37; }

        .speed-control-container {
            margin-top: auto; /* Empuja esto al fondo del panel */
            padding-top: 15px;
            border-top: 1px dashed #eee;
        }

        /* --- COLUMNA 2: SECUENCIAS --- */
        .accordion-button { padding: 10px 15px; background-color: #fff; font-size: 0.95rem; }
        .accordion-button:not(.collapsed) { color: #0d6efd; background-color: #e7f1ff; box-shadow: none; }
        .accordion-button:focus { box-shadow: none; }
        
        /* --- COLUMNA 3: LOG --- */
        .log-enhanced { 
            background-color: #1a1a1a; 
            color: #00ff00; 
            font-family: 'Consolas', monospace; 
            padding: 10px; 
            font-size: 12px; 
            height: 100%; 
            overflow-y: auto; 
        }
        .log-line { border-bottom: 1px solid #333; padding: 4px 0; display: flex; align-items: flex-start; }
        
        /* HORA EN BLANCO (CORREGIDO) */
        .log-time { color: #ffffff !important; font-weight: bold; margin-right: 8px; min-width: 65px; opacity: 0.9; }
        .log-msg { word-break: break-word; }
        
        .text-success { color: #00e676 !important; }
        .text-warning { color: #ffea00 !important; }
        .text-danger { color: #ff5252 !important; }

        /* Responsive */
        @media (max-width: 992px) {
            body, html { overflow: auto; height: auto; }
            .app-container { height: auto; display: block; }
            .content-area { height: auto; padding: 10px; }
            .dashboard-grid { display: flex; flex-direction: column; gap: 20px; height: auto; }
            .panel { height: 500px; } /* Altura fija en m√≥vil */
            .navbar, .footer { position: relative; }
        }
    </style>
</head>
<body>

<div class="app-container">

    <nav class="navbar shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-4" href="../">
          <i class="fas fa-robot text-primary me-2"></i>IoT Car
        </a>
        <div class="d-flex align-items-center gap-2">
          <span id="connection-status" class="badge bg-danger">Desconectado</span>
          <a href="../" class="btn btn-sm btn-outline-secondary"><i class="fas fa-home"></i></a>
        </div>
      </div>
    </nav>

    <div class="content-area">
        <div class="dashboard-grid">

            <div class="panel">
                <div class="panel-header"><i class="fas fa-gamepad text-primary me-2"></i>Control Manual</div>
                
                <div class="panel-body d-flex flex-column">
                    <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                        <div class="drive-pad-enhanced">
                            <button class="drive-btn drive-btn-corner" onclick="enviarComando('ADELANTE_IZQUIERDA')">‚ÜñÔ∏è</button>
                            <button class="drive-btn" onclick="enviarComando('ADELANTE')">‚¨ÜÔ∏è</button>
                            <button class="drive-btn drive-btn-corner" onclick="enviarComando('ADELANTE_DERECHA')">‚ÜóÔ∏è</button>

                            <button class="drive-btn" onclick="enviarComando('GIRO_90_IZQUIERDA')">‚¨ÖÔ∏è</button>
                            <button class="drive-btn drive-btn-stop" onclick="enviarComando('DETENER')">üõë</button>
                            <button class="drive-btn" onclick="enviarComando('GIRO_90_DERECHA')">‚û°Ô∏è</button>

                            <button class="drive-btn drive-btn-corner" onclick="enviarComando('ATRAS_IZQUIERDA')">‚ÜôÔ∏è</button>
                            <button class="drive-btn" onclick="enviarComando('ATRAS')">‚¨áÔ∏è</button>
                            <button class="drive-btn drive-btn-corner" onclick="enviarComando('ATRAS_DERECHA')">‚ÜòÔ∏è</button>
                        </div>
                        
                        <div class="text-center mt-3 d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarComando('GIRO_360_IZQUIERDA')">üîÑ 360 I</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="enviarComando('GIRO_360_DERECHA')">üîÑ 360 D</button>
                        </div>
                    </div>

                    <div class="speed-control-container text-center">
                        <label class="small fw-bold text-muted mb-2">POTENCIA DE MOTOR: <span id="velocidad-texto" class="text-dark">MEDIA (60%)</span></label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="setVelocidad(40)">üê¢ Baja</button>
                            <button type="button" class="btn btn-outline-warning active" onclick="setVelocidad(60)">üö∂ Media</button>
                            <button type="button" class="btn btn-outline-danger" onclick="setVelocidad(100)">üêá Alta</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header bg-success text-white">
                    <span><i class="fas fa-play-circle me-2"></i>Secuencias</span>
                    <button class="btn btn-sm btn-light py-0 text-success" onclick="cargarSecuenciasDeBD()"><i class="fas fa-sync-alt"></i></button>
                </div>
                
                <div class="panel-body p-0" style="background-color: #fff;">
                    <div class="accordion accordion-flush" id="accordionSecuencias">
                        <div class="p-5 text-center text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>Cargando secuencias...
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-light border-top">
                    <div class="input-group mb-2">
                        <span class="input-group-text bg-white"><i class="fas fa-pen"></i></span>
                        <input type="text" id="secuenciaNombre" class="form-control" placeholder="Nombre nueva secuencia...">
                        <button id="btn-record" class="btn btn-danger" onclick="toggleRecording()"><i class="fas fa-circle"></i> REC</button>
                    </div>
                    <div id="current-sequence-display" class="small text-muted mb-2 text-truncate border rounded p-1 bg-white">...</div>
                    <div class="d-flex gap-2">
                        <button id="btn-save-sequence" class="btn btn-primary flex-grow-1" onclick="guardarSecuencia()" disabled>Guardar</button>
                        <button class="btn btn-outline-secondary" onclick="limpiarSecuencia()"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header bg-dark text-white"><i class="fas fa-terminal me-2"></i>Terminal</div>
                
                <div class="panel-body p-0">
                    <div class="log-enhanced" id="log">
                        <div class="log-line"><span class="log-time text-white">SYSTEM</span> <span class="text-success">Interfaz iniciada...</span></div>
                    </div>
                </div>
                
                <div class="p-3 border-top bg-light">
                     <button class="btn btn-warning w-100 fw-bold shadow-sm" onclick="simularObstaculo()">
                        <i class="fas fa-exclamation-triangle me-2"></i>Simular Obst√°culo
                     </button>
                </div>
            </div>

        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <span class="text-muted fw-bold">Mary Jose Hern√°ndez Fern√°ndez</span>
            <span class="mx-2">|</span>
            <small class="text-muted">Ingenier√≠a en Sistemas</small>
            <a href="https://linkedin.com" target="_blank" class="ms-3 text-primary"><i class="fab fa-linkedin"></i></a>
        </div>
    </footer>

</div>

<script>
    const HOST_IP = "18.207.21.168"; 
    const WS_PORT = "5500";
    const WS_URL = `ws://${HOST_IP}:${WS_PORT}/api/ws`; 
    const API_URL = `http://${HOST_IP}:${WS_PORT}/api`;

    let socket;
    let velocidadActual = 60;
    let isRecording = false;
    let currentSequence = [];

    // --- UTILIDADES ---
    function addLog(msg, type = "info") {
        const logDiv = document.getElementById("log");
        const time = new Date().toLocaleTimeString();
        let colorClass = "text-white"; 
        
        if (type === "error") colorClass = "text-danger";
        if (type === "warning") colorClass = "text-warning";
        if (type === "success") colorClass = "text-success";

        logDiv.innerHTML += `
            <div class="log-line">
                <span class="log-time">${time}</span> 
                <span class="log-msg ${colorClass}">${msg}</span>
            </div>
        `;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // --- WEBSOCKET ---
    function conectarWebSocket() {
        addLog("Conectando WebSocket...", "warning");
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            document.getElementById("connection-status").className = "badge bg-success ms-2";
            document.getElementById("connection-status").innerText = "Online";
            addLog("Sistema Conectado ‚úÖ", "success");
            cargarSecuenciasDeBD();
        };

        socket.onclose = () => {
            document.getElementById("connection-status").className = "badge bg-danger ms-2";
            document.getElementById("connection-status").innerText = "Offline";
            addLog("Desconectado. Reintentando...", "error");
            setTimeout(conectarWebSocket, 3000);
        };
        
        socket.onmessage = (event) => {
            try {
                const msg = JSON.parse(event.data);
                
                if (msg.type === "new_movement") {
                    addLog(`MOTOR: ${msg.movement.movement_code} (${msg.movement.speed_pct}%)`);
                } 
                else if (msg.type === "new_obstacle") {
                    const dist = msg.obstacle.distance_cm;
                    addLog(`üö® ALERTA: Obst√°culo a ${dist}cm`, "warning");
                }
                else if (msg.type === "movement_done") {
                    if (msg.code === "OBSTACULO_SUPERADO") addLog("‚úÖ Obst√°culo evadido.", "success");
                }
                else if (msg.type === "sequences_updated") {
                    addLog("Base de datos actualizada", "info");
                    cargarSecuenciasDeBD();
                }
            } catch(e) {}
        };
    }

    // --- CONTROL ---
    window.setVelocidad = (pct) => {
        velocidadActual = pct;
        let txt = pct <= 45 ? "BAJA" : (pct >= 80 ? "ALTA" : "MEDIA");
        document.getElementById("velocidad-texto").innerText = `${txt} (${pct}%)`;
        
        // Estilo visual botones
        const btns = document.querySelectorAll('.speed-control-container .btn');
        btns.forEach(b => b.classList.remove('active'));
    };

    window.enviarComando = (codigo) => {
        if (isRecording) {
            currentSequence.push(codigo);
            document.getElementById("current-sequence-display").innerText = currentSequence.join(" > ");
        }
        const payload = { direction: codigo, speed_pct: velocidadActual, comment: "Manual Web" };
        fetch(`${API_URL}/control/move`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(() => addLog("Error API", "error"));
    };

    window.simularObstaculo = () => {
        addLog("Enviando simulaci√≥n...", "warning");
        fetch(`${API_URL}/control/obstacle`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ distanceCm: 10, thresholdCm: 20 })
        });
    };

    // --- SECUENCIAS ---
    window.toggleRecording = () => {
        isRecording = !isRecording;
        const btn = document.getElementById("btn-record");
        if (isRecording) {
            currentSequence = [];
            btn.innerHTML = '<i class="fas fa-stop"></i>';
            btn.className = "btn btn-warning";
            addLog("Grabando secuencia...", "warning");
        } else {
            btn.innerHTML = '<i class="fas fa-circle"></i> REC';
            btn.className = "btn btn-danger";
            document.getElementById("btn-save-sequence").disabled = currentSequence.length === 0;
            addLog("Grabaci√≥n finalizada");
        }
    };

    window.guardarSecuencia = () => {
        const nombre = document.getElementById("secuenciaNombre").value;
        if (!nombre) return alert("Escribe un nombre");
        
        fetch(`${API_URL}/sequences`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: nombre, steps: currentSequence })
        }).then(() => {
            addLog("Secuencia guardada exitosamente", "success");
            currentSequence = [];
            document.getElementById("current-sequence-display").innerText = "...";
            document.getElementById("secuenciaNombre").value = "";
            cargarSecuenciasDeBD();
        });
    };

    window.limpiarSecuencia = () => {
        currentSequence = [];
        document.getElementById("current-sequence-display").innerText = "...";
    };

    window.cargarSecuenciasDeBD = () => {
        fetch(`${API_URL}/sequences`)
        .then(r => r.json())
        .then(data => {
            const accordion = document.getElementById("accordionSecuencias");
            accordion.innerHTML = "";
            
            if (data.length === 0) {
                accordion.innerHTML = '<div class="p-5 text-center text-muted">No hay secuencias guardadas.</div>';
                return;
            }

            data.forEach((seq, index) => {
                const id = `collapse${index}`;
                // Badges
                const stepsBadges = seq.steps.map(s => {
                    let color = "bg-primary";
                    if(s==="DETENER") color="bg-danger";
                    if(s==="obstacle") color="bg-warning text-dark";
                    return `<span class="badge ${color} m-1">${s}</span>`;
                }).join("");

                const item = `
                <div class="accordion-item border-0 border-bottom">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}">
                            <div class="d-flex w-100 justify-content-between align-items-center me-2">
                                <span class="fw-bold text-dark">${seq.name}</span>
                                <span class="badge bg-secondary rounded-pill">${seq.steps.length} pasos</span>
                            </div>
                        </button>
                    </h2>
                    <div id="${id}" class="accordion-collapse collapse" data-bs-parent="#accordionSecuencias">
                        <div class="accordion-body bg-light">
                            <div class="d-flex flex-wrap gap-1 mb-2">${stepsBadges}</div>
                            <button class="btn btn-success btn-sm w-100" onclick="ejecutarSecuencia('${seq.name}')">
                                <i class="fas fa-play me-2"></i> Ejecutar
                            </button>
                        </div>
                    </div>
                </div>`;
                accordion.innerHTML += item;
            });
        })
        .catch(err => {
            console.error("Error lista", err);
            document.getElementById("accordionSecuencias").innerHTML = '<div class="p-3 text-center text-danger">Error al cargar datos.</div>';
        });
    };

    window.ejecutarSecuencia = (nombre) => {
        addLog(`‚ñ∂ Ejecutando: ${nombre}`, "info");
        fetch(`${API_URL}/control/run-sequence`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: nombre })
        });
    };

    conectarWebSocket();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>