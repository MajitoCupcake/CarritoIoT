<<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Carrito IoT</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background-color: #eef; padding: 20px; }
        h1 { color: #333; }
        
        /* Estilos para el panel de botones */
        .control-panel { display: inline-block; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Botones de Direcci√≥n */
        .btn-dir { width: 80px; height: 80px; margin: 5px; font-size: 24px; cursor: pointer; border: none; border-radius: 10px; background: #ddd; }
        .btn-dir:active { background: #bbb; transform: scale(0.95); }
        .btn-stop { background: #f44336; color: white; }

        /* Botones de Velocidad */
        .speed-panel { margin-top: 20px; padding: 10px; border: 2px solid #ccc; border-radius: 10px; background: #f9f9f9; }
        .btn-vel { padding: 10px 15px; margin: 0 5px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; }
        .vel-low { background-color: #8bc34a; }
        .vel-med { background-color: #ffc107; color: black; }
        .vel-high { background-color: #2196F3; }
        
        #status { font-weight: bold; color: orange; }
        .connected { color: green !important; }
        .disconnected { color: red !important; }
    </style>
</head>
<body>

    <h1>üöó Control IoT Carrito</h1>
    <p>Estado: <span id="status" class="disconnected">Desconectado</span></p>

    <div class="control-panel">
        <div>
            <button class="btn-dir" onclick="enviarComando('ADELANTE_IZQUIERDA')">‚ÜñÔ∏è</button>
            <button class="btn-dir" onclick="enviarComando('ADELANTE')">‚¨ÜÔ∏è</button>
            <button class="btn-dir" onclick="enviarComando('ADELANTE_DERECHA')">‚ÜóÔ∏è</button>
        </div>
        <div>
            <button class="btn-dir" onclick="enviarComando('GIRO_90_IZQUIERDA')">‚¨ÖÔ∏è</button>
            <button class="btn-dir btn-stop" onclick="enviarComando('DETENER')">üõë</button>
            <button class="btn-dir" onclick="enviarComando('GIRO_90_DERECHA')">‚û°Ô∏è</button>
        </div>
        <div>
            <button class="btn-dir" onclick="enviarComando('ATRAS_IZQUIERDA')">‚ÜôÔ∏è</button>
            <button class="btn-dir" onclick="enviarComando('ATRAS')">‚¨áÔ∏è</button>
            <button class="btn-dir" onclick="enviarComando('ATRAS_DERECHA')">‚ÜòÔ∏è</button>
        </div>
        
        <div style="margin-top:10px;">
            <button class="btn-dir" style="font-size:14px;" onclick="enviarComando('GIRO_360_IZQUIERDA')">üîÑ 360 I</button>
            <button class="btn-dir" style="font-size:14px;" onclick="enviarComando('GIRO_360_DERECHA')">üîÑ 360 D</button>
        </div>

        <div class="speed-panel">
            <h3>‚ö° Velocidad</h3>
            <button class="btn-vel vel-low" onclick="setVelocidad(40)">üê¢ Baja</button>
            <button class="btn-vel vel-med" onclick="setVelocidad(60)">üö∂ Media</button>
            <button class="btn-vel vel-high" onclick="setVelocidad(100)">üêá Alta</button>
            <p>Modo: <strong id="texto-velocidad" style="color: #333;">MEDIA (60%)</strong></p>
        </div>

    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const WS_URL = "ws://18.207.21.168:5500/ws"; // Revisa si es /ws o /api/ws
        let socket;
        let velocidadActual = 60; // Velocidad por defecto

        // --- CONEXI√ìN WEBSOCKET ---
        function conectarWebSocket() {
            console.log("Conectando...");
            socket = new WebSocket(WS_URL);

            socket.onopen = function() {
                document.getElementById("status").innerText = "üü¢ Conectado";
                document.getElementById("status").className = "connected";
                console.log("WS Conectado");
            };

            socket.onclose = function() {
                document.getElementById("status").innerText = "üî¥ Desconectado";
                document.getElementById("status").className = "disconnected";
                console.log("WS Desconectado. Reintentando en 3s...");
                setTimeout(conectarWebSocket, 3000);
            };

            socket.onerror = function(error) {
                console.error("Error WS:", error);
            };
        }

        // --- FUNCI√ìN DE VELOCIDAD ---
        function setVelocidad(porcentaje) {
            velocidadActual = porcentaje;
            let texto = "MEDIA";
            if(porcentaje <= 45) texto = "BAJA";
            if(porcentaje >= 80) texto = "ALTA";
            document.getElementById("texto-velocidad").innerText = `${texto} (${porcentaje}%)`;
        }

        // --- ENVIAR COMANDO ---
        function enviarComando(codigo) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;

            const payload = {
                "device_id": 1,
                "movement_code": codigo,
                "speed_pct": velocidadActual // <--- AQU√ç SE MANDA LA VELOCIDAD
            };

            socket.send(JSON.stringify({
                "type": "new_movement",
                "movement": payload
            }));
            console.log(`Enviado: ${codigo} | Vel: ${velocidadActual}%`);
        }

        // Iniciar conexi√≥n al cargar
        conectarWebSocket();
    </script>

</body>
</html>