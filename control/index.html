<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>IoT Cart Manager · Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold fs-3" href="../">
      <i class="fas fa-robot text-primary me-2"></i>IoT Cart Manager
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-outline-primary" href="../">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
      </a>
      <a class="btn btn-primary active" href="./">
        <i class="fas fa-gamepad me-1"></i>Control
      </a>
      <a class="btn btn-outline-primary" href="../monitor/">
        <i class="fas fa-satellite-dish me-1"></i>Monitoreo
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="row g-4">
    <div class="col-lg-7">
      
      <div class="card control-card shadow-lg border-0 mb-4">
        <div class="card-body p-4">
          <h1 class="display-5 fw-bold text-primary mb-3 text-center">Control Manual</h1>
          <div class="drive-pad-enhanced">
            <button class="drive-btn drive-btn-corner" data-move="forward_left">
              <i class="fas fa-arrow-up-left"></i>
            </button>
            <button class="drive-btn drive-btn-up" data-move="forward">
              <i class="fas fa-arrow-up"></i>
            </button>
            <button class="drive-btn drive-btn-corner" data-move="forward_right">
              <i class="fas fa-arrow-up-right"></i>
            </button>
            <button class="drive-btn drive-btn-left" data-move="rotate_left">
              <i class="fas fa-undo"></i>
            </button>
            <button class="drive-btn drive-btn-stop" data-move="stop">
              <i class="fas fa-stop"></i>
            </button>
            <button class="drive-btn drive-btn-right" data-move="rotate_right">
              <i class="fas fa-redo"></i>
            </button>
            <button class="drive-btn drive-btn-corner" data-move="backward_left">
              <i class="fas fa-arrow-down-left"></i>
            </button>
            <button class="drive-btn drive-btn-down" data-move="backward">
              <i class="fas fa-arrow-down"></i>
            </button>
            <button class="drive-btn drive-btn-corner" data-move="backward_right">
              <i class="fas fa-arrow-down-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-list-ol me-2"></i>Secuencias Guardadas
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="saved-sequences-list">
            <div class="list-group-item text-center p-4">
              <i class="fas fa-spinner fa-spin me-2"></i>Cargando secuencias...
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="col-lg-5">
      
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-magic-wand-sparkles me-2"></i>Creador de Secuencias
          </h5>
        </div>
        <div class="card-body text-center">
          <button id="btn-record" class="btn btn-danger btn-lg w-100">
            <i class="fas fa-circle me-2"></i> Iniciar Grabación
          </button>
          <button id="btn-stop-record" class="btn btn-secondary btn-lg w-100 d-none">
            <i class="fas fa-stop-circle me-2"></i> Detener Grabación
          </button>

          <hr>

          <h6 class="text-muted text-start">Secuencia Actual:</h6>
          <div class="sequence-display" id="current-sequence-display">
            <span class="text-muted fst-italic">Presiona "Iniciar Grabación"</span>
          </div>

          <div class="d-grid gap-2 mt-3">
            <button id="btn-save-sequence" class="btn btn-primary" disabled>
              <i class="fas fa-save me-2"></i> Guardar Secuencia
            </button>
            <button id="btn-clear-sequence" class="btn btn-outline-danger" disabled>
              <i class="fas fa-trash me-2"></i> Limpiar
            </button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-header bg-dark text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-terminal me-2"></i>Registro de Comandos
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="log-enhanced" id="log"></div>
        </div>
      </div>

      <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-cogs me-2"></i>Acciones Especiales
          </h5>
        </div>
        <div class="card-body d-grid gap-2">
            <button id="btnDemoL" class="btn btn-outline-primary">
              <i class="fas fa-sync-alt me-2"></i>Giro 360° Izquierda
            </button>
            <button id="btnDemoR" class="btn btn-outline-primary">
              <i class="fas fa-sync-alt me-2"></i>Giro 360° Derecha
            </button>
            <button id="btnObstacle" class="btn btn-outline-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>Simular Obstáculo
            </button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="footer mt-5 py-4 bg-light border-top">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="mb-0 fw-bold fs-5">
          <i class="fas fa-user-graduate me-2 text-primary"></i>
          Mary Jose Hernández Fernández
        </p>
        <p class="mb-0 text-muted fs-6">
          <i class="fas fa-laptop-code me-2"></i>
          Ingeniería en Sistemas Computacionales
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <a href="https://www.linkedin.com/in/mary-jose-hernández-fernández" 
           class="btn btn-outline-primary btn-lg" target="_blank">
          <i class="fab fa-linkedin me-2"></i>
          Conectar en LinkedIn
        </a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
  import { API_BASE, WS_URL } from "../assets/js/config.js";
  import { sendMove, sendDemo, sendObstacle, getSequences, saveSequence, runSequence } from "../assets/js/api.js";
  import { connectWS, onWSMessage, sendWSMessage } from "../assets/js/ws.js";

  // --- Estado Global ---
  const log = document.getElementById("log");
  let isRecording = false;
  let currentSequence = [];

  // --- Elementos del DOM ---
  const btnRecord = document.getElementById("btn-record");
  const btnStopRecord = document.getElementById("btn-stop-record");
  const btnSaveSequence = document.getElementById("btn-save-sequence");
  const btnClearSequence = document.getElementById("btn-clear-sequence");
  const currentSequenceDisplay = document.getElementById("current-sequence-display");
  const savedSequencesList = document.getElementById("saved-sequences-list");

  // --- Funciones de UI ---
  
  function showAlert(message, type = 'success') {
    const alertClass = type === 'error' ? 'alert-danger' : (type === 'info' ? 'alert-info' : 'alert-success');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      <strong>${type === 'error' ? 'Error!' : (type === 'info' ? 'Info:' : 'Éxito!')}</strong> ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => { if (alertDiv.parentNode) alertDiv.remove(); }, 3000);
  }

  function addLog(txt, err = false) {
    const line = document.createElement("div");
    const stamp = new Date().toLocaleTimeString();
    line.className = `log-line ${err ? 'log-error' : 'log-success'}`;
    line.innerHTML = `
      <span class="log-time">[${stamp}]</span>
      <span class="log-message">${txt}</span>
      ${err ? '<i class="fas fa-exclamation-triangle ms-2"></i>' : '<i class="fas fa-check-circle ms-2"></i>'}
    `;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
  }

  // --- Lógica de Secuencias ---

  function updateSequenceDisplay() {
    if (currentSequence.length === 0) {
      currentSequenceDisplay.innerHTML = `<span class="text-muted fst-italic">${isRecording ? 'Presiona los controles...' : 'Secuencia vacía'}</span>`;
      btnSaveSequence.disabled = true;
      btnClearSequence.disabled = true;
      return;
    }
    
    currentSequenceDisplay.innerHTML = currentSequence.map(step => {
      const iconMap = {
        'forward': 'arrow-up', 'backward': 'arrow-down', 'stop': 'stop',
        'rotate_left': 'undo', 'rotate_right': 'redo',
        'forward_left': 'arrow-up-left', 'forward_right': 'arrow-up-right',
        'backward_left': 'arrow-down-left', 'backward_right': 'arrow-down-right'
      };
      return `<span class="badge bg-primary p-2 m-1 fs-6"><i class="fas fa-${iconMap[step] || 'question'}"></i> ${step}</span>`;
    }).join("");
    
    btnSaveSequence.disabled = isRecording;
    btnClearSequence.disabled = isRecording;
  }

  async function loadSavedSequences() {
    try {
      const sequences = await getSequences();
      savedSequencesList.innerHTML = "";
      
      if (!sequences || sequences.length === 0) {
        savedSequencesList.innerHTML = `<div class="list-group-item text-center p-4 text-muted">No hay secuencias guardadas.</div>`;
        return;
      }
      
      sequences.forEach(seq => {
        const item = document.createElement("a");
        item.href = "#";
        item.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
        item.innerHTML = `
          <div>
            <strong class="fs-5">${seq.name}</strong>
            <div class="small text-muted">${seq.steps.length} pasos</div>
          </div>
          <button class="btn btn-success btn-run-sequence" data-name="${seq.name}">
            <i class="fas fa-play me-2"></i> Ejecutar
          </button>
        `;
        savedSequencesList.appendChild(item);
      });

    } catch (e) {
      savedSequencesList.innerHTML = `<div class="list-group-item text-center p-4 text-danger">Error al cargar secuencias.</div>`;
      showAlert(`Error cargando secuencias: ${e.message}`, 'error');
    }
  }

  // --- Event Listeners ---

  // Botones de Control
  document.querySelectorAll(".drive-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const dir = btn.dataset.move;
      
      // Lógica de grabación
      if (isRecording) {
        currentSequence.push(dir);
        updateSequenceDisplay();
      }
      
      // Enviar comando (siempre)
      try {
        const res = await sendMove(dir, 70);
        showAlert(res.message);
        addLog(res.message);
        sendWSMessage({ type: "movement", direction: dir });
      } catch(e) {
        showAlert(`Error: ${e.message}`, 'error');
        addLog(`Error en "${dir}": ${e}`, true);
      }
    });
  });

  // Botones de Grabación
  btnRecord.addEventListener("click", () => {
    isRecording = true;
    currentSequence = [];
    updateSequenceDisplay();
    btnRecord.classList.add("d-none");
    btnStopRecord.classList.remove("d-none");
    showAlert("Grabación iniciada", 'info');
  });

  btnStopRecord.addEventListener("click", () => {
    isRecording = false;
    updateSequenceDisplay();
    btnRecord.classList.remove("d-none");
    btnStopRecord.classList.add("d-none");
    showAlert("Grabación detenida", 'info');
  });

  btnClearSequence.addEventListener("click", () => {
    currentSequence = [];
    updateSequenceDisplay();
    showAlert("Secuencia limpiada", 'info');
  });

  btnSaveSequence.addEventListener("click", async () => {
    const name = prompt("Ingresa un nombre para la secuencia:", "Mi Secuencia");
    if (!name || name.trim() === "") {
      showAlert("Guardado cancelado", 'info');
      return;
    }
    
    try {
      await saveSequence(name, currentSequence);
      showAlert("Secuencia guardada con éxito");
      currentSequence = [];
      updateSequenceDisplay();
      loadSavedSequences(); // Recargar la lista
    } catch(e) {
      showAlert(`Error al guardar: ${e.message}`, 'error');
    }
  });

  // Botones de Ejecutar Secuencia (Delegación de eventos)
  savedSequencesList.addEventListener("click", async (e) => {
    const target = e.target.closest(".btn-run-sequence");
    if (target) {
      e.preventDefault();
      const name = target.dataset.name;
      target.disabled = true;
      target.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i> Ejecutando...`;
      
      showAlert(`Ejecutando secuencia: ${name}`, 'info');
      try {
        const res = await runSequence(name);
        showAlert(res.message);
      } catch (e) {
        showAlert(`Error al ejecutar: ${e.message}`, 'error');
      } finally {
        target.disabled = false;
        target.innerHTML = `<i class="fas fa-play me-2"></i> Ejecutar`;
      }
    }
  });

  // Botones de Acciones Especiales
  document.getElementById("btnDemoL").onclick = async () => {
    try {
      await sendDemo("spin_left", 10);
      showAlert("Demo: Giro 360° Izquierda ejecutada");
      addLog(`Demo "spin_left" ejecutada`);
    } catch(e) {
      showAlert(`Error en demo: ${e}`, 'error');
      addLog(`Error en demo: ${e}`, true);
    }
  };

  document.getElementById("btnDemoR").onclick = async () => {
    try {
      await sendDemo("spin_right", 10);
      showAlert("Demo: Giro 360° Derecha ejecutada");
      addLog(`Demo "spin_right" ejecutada`);
    } catch(e) {
      showAlert(`Error en demo: ${e}`, 'error');
      addLog(`Error en demo: ${e}`, true);
    }
  };

  document.getElementById("btnObstacle").onclick = async () => {
    try {
      await sendObstacle(15, 20);
      showAlert("Obstáculo simulado a 15cm");
      addLog(`Obstáculo simulado a 15cm`);
    } catch(e) {
      showAlert(`Error simulando obstáculo: ${e}`, 'error');
      addLog(`Error en obstáculo: ${e}`, true);
    }
  };

  // --- WebSocket ---
  connectWS();
  onWSMessage(msg => {
    if (msg.type === "new_movement") {
      addLog(`PUSH (Movimiento): ${msg.movement.movement}`);
    } else if (msg.type === "sequences_updated") {
      showAlert("Lista de secuencias actualizada", 'info');
      loadSavedSequences(); // Recargar la lista por PUSH
    } else if (msg.type === "sequence_started") {
      addLog(`INICIO SECUENCIA: ${msg.name}`);
    } else if (msg.type === "sequence_finished") {
      addLog(`FIN SECUENCIA: ${msg.name}`);
    }
  });

  // --- Inicialización ---
  updateSequenceDisplay();
  loadSavedSequences();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>