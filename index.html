<!doctype html>
<html lang="es"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IoT Cart Manager Â· Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="./assets/css/styles.css" rel="stylesheet"></head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><span class="emoji">ðŸ¤–</span>IoT Cart Manager</a>
    <div class="d-flex align-items-center gap-2">
      <button id="themeBtn" class="theme-toggle">ðŸŒ“</button>
      <a class="btn btn-outline-secondary" href="./">Dashboard</a>
      <a class="btn btn-outline-secondary" href="./control/">ðŸŽ® Control</a>
      <a class="btn btn-outline-secondary" href="./monitor/">ðŸ“¡ Monitoreo</a>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">âž• Add Device</button>
    </div>
  </div>
</nav>
<div class="container py-4">
  <h3 class="mb-3">Dashboard</h3>
  <div class="row g-3">
    <div class="col-md-4"><div class="card h-100"><div class="card-body">
      <h5 class="card-title">Last Movement Status</h5>
      <div id="last-move" class="mt-3">
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Movement</span><span id="lm-move" class="fw-bold">â€”</span></div>
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Speed</span><span id="lm-speed">â€”</span></div>
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Comment</span><span id="lm-comment">â€”</span></div>
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Time</span><span id="lm-time">â€”</span></div>
      </div>
    </div></div></div>
    <div class="col-md-4"><div class="card h-100"><div class="card-body">
      <h5 class="card-title">Last Obstacle Status</h5>
      <div id="last-obs" class="mt-3">
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Status</span><span id="lo-status" class="fw-bold">â€”</span></div>
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Distance</span><span id="lo-dist">â€”</span></div>
        <div class="d-flex align-items-center gap-2"><span class="badge-soft">Time</span><span id="lo-time">â€”</span></div>
      </div>
    </div></div></div>
    <div class="col-md-4"><div class="card h-100"><div class="card-body">
      <h5 class="card-title">Command Log (WS)</h5>
      <div class="log" id="ws-log"></div>
    </div></div></div>
  </div>
  <div class="card mt-4"><div class="card-body">
    <h5 class="card-title">Last 10 Movements</h5>
    <div class="table-responsive table-sticky">
      <table class="table align-middle" id="tbl-moves">
        <thead><tr><th>Movement</th><th>Speed</th><th>Comment</th><th>Timestamp</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div></div>
</div>
<div class="modal fade" id="addDeviceModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Add New Device</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
  <div class="modal-body"><label class="form-label">Name</label><input id="newDeviceName" class="form-control" value="NewDevice"></div>
  <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" id="saveDeviceBtn" data-bs-dismiss="modal">Save</button></div>
</div></div></div>
<script type="module">
import "./assets/js/config.js";
import { getLastMovement,getLastObstacle,getMovements } from "./assets/js/api.js";
import { connectWS,onWSMessage } from "./assets/js/ws.js";
function text(el,val){ el.textContent = val ?? "â€”"; }
function fmt(x){ return x?.time || x?.timestamp || x?.fecha || "â€”"; }
async function loadLasts(){ try{ const [lm,lo]=await Promise.all([getLastMovement(),getLastObstacle()]); const m=Array.isArray(lm)&&lm[0]?lm[0]:lm; const o=Array.isArray(lo)&&lo[0]?lo[0]:lo; text(document.getElementById("lm-move"),m?.movement||m?.status||"â€”"); text(document.getElementById("lm-speed"),(m?.speed!=null? m.speed+"%":"â€”")); text(document.getElementById("lm-comment"),m?.comment||"â€”"); text(document.getElementById("lm-time"),fmt(m)); text(document.getElementById("lo-status"),o?.status||"â€”"); text(document.getElementById("lo-dist"),(o?.distance_cm!=null? o.distance_cm+" cm": (o?.distance? o.distance+" cm":"â€”"))); text(document.getElementById("lo-time"),fmt(o)); }catch(e){ console.error(e);} }
async function loadTable(){ try{ const rows=await getMovements(); const tb=document.querySelector("#tbl-moves tbody"); tb.innerHTML=""; (rows||[]).forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td><span class="badge-soft">${r.movement||r.status||"â€”"}</span></td><td>${r.speed!=null? r.speed+"%":"â€”"}</td><td>${r.comment||""}</td><td>${r.timestamp||r.time||""}</td>`; tb.appendChild(tr);}); }catch(e){ console.error(e);} }
function initWS(){ const log=document.getElementById("ws-log"); connectWS(); onWSMessage(msg=>{ const div=document.createElement("div"); const stamp=new Date().toLocaleTimeString(); div.innerHTML=`<span class="stamp">[${stamp}]</span> ${JSON.stringify(msg).replaceAll("<","&lt;").replaceAll(">","&gt;")}`; log.appendChild(div); log.scrollTop=log.scrollHeight; }); }
function initTheme(){ const btn=document.getElementById("themeBtn"); const apply=(t)=>{ document.documentElement.setAttribute("data-theme",t); localStorage.setItem("theme",t); }; let cur=localStorage.getItem("theme")||"light"; apply(cur); btn.onclick=()=>{ cur=cur==="light"?"dark":"light"; apply(cur); }; }
document.getElementById("saveDeviceBtn").onclick=()=>{ const name=document.getElementById("newDeviceName").value||"NewDevice"; alert("Saved device: "+name+" (solo UI)"); };
initTheme(); initWS(); loadLasts(); loadTable(); setInterval(()=>{ loadLasts(); loadTable(); }, 6000);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body></html>
