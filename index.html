<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>IoT Cart Manager ¬∑ Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-white border-bottom sticky-top">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold fs-3" href="#">
      <i class="fas fa-robot text-primary me-2"></i>IoT Cart Manager
    </a>
    <div class="d-flex align-items-center gap-2">
      <a class="btn btn-primary active" href="./">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
      </a>
      <a class="btn btn-outline-primary" href="./control/">
        <i class="fas fa-gamepad me-1"></i>Control
      </a>
      <a class="btn btn-outline-primary" href="./monitor/">
        <i class="fas fa-satellite-dish me-1"></i>Monitoreo
      </a>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-primary mb-3">Dashboard Principal</h1>
    <p class="lead text-muted fs-4">Visi√≥n general del sistema IoT en tiempo real (PUSH)</p>
  </div>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-directions me-2"></i>√öltimo Movimiento
          </h5>
        </div>
        <div class="card-body">
          <div id="last-move" class="mt-3">
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge bg-light text-dark fs-6">Movimiento</span>
              <span id="lm-move" class="fw-bold fs-5">‚Äî</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge bg-light text-dark fs-6">Velocidad</span>
              <span id="lm-speed" class="fs-5">‚Äî</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge bg-light text-dark fs-6">Comentario</span>
              <span id="lm-comment" class="fs-6">‚Äî</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-light text-dark fs-6">Tiempo</span>
              <span id="lm-time" class="fs-6">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-warning text-dark">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-exclamation-triangle me-2"></i>Estado de Obst√°culos
          </h5>
        </div>
        <div class="card-body">
          <div id="last-obs" class="mt-3">
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge bg-light text-dark fs-6">Estado</span>
              <span id="lo-status" class="fw-bold fs-5">‚Äî</span>
            </div>
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge bg-light text-dark fs-6">Distancia</span>
              <span id="lo-dist" class="fs-5">‚Äî</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-light text-dark fs-6">Tiempo</span>
              <span id="lo-time" class="fs-6">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100 shadow-sm border-0">
        <div class="card-header bg-info text-white">
          <h5 class="card-title mb-0 fs-4">
            <i class="fas fa-broadcast-tower me-2"></i>Log WebSocket
          </h5>
        </div>
        <div class="card-body p-0">
          <div class="log-enhanced" id="ws-log"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<footer class="footer mt-5 py-4 bg-light border-top">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6">
        <p class="mb-0 fw-bold fs-5">
          <i class="fas fa-user-graduate me-2 text-primary"></i>
          Mary Jose Hern√°ndez Fern√°ndez
        </p>
        <p class="mb-0 text-muted fs-6">
          <i class="fas fa-laptop-code me-2"></i>
          Ingenier√≠a en Sistemas Computacionales
        </p>
      </div>
      <div class="col-md-6 text-md-end">
        <a href="https://www.linkedin.com/in/mary-jose-hern√°ndez-fern√°ndez" 
           class="btn btn-outline-primary btn-lg" target="_blank">
          <i class="fab fa-linkedin me-2"></i>
          Conectar en LinkedIn
        </a>
      </div>
    </div>
  </div>
</footer>

<script type="module">
  import { API_BASE, WS_URL } from "./assets/js/config.js";
  import { getLastMovement, getLastObstacle } from "./assets/js/api.js";
  import { connectWS, onWSMessage, sendWSMessage } from "./assets/js/ws.js";

  const log = document.getElementById("ws-log");
  
  function text(el, val) {
    if (el) {
      el.textContent = val ?? "‚Äî";
    }
  }
  
  function initWS() {
    connectWS();
    onWSMessage(async (msg) => {
      
      let message = "";
      const stamp = new Date().toLocaleTimeString();
      const div = document.createElement("div");

      if (msg.type === "connection") {
          message = "üîå Conectado - Cargando datos...";
          div.className = "log-line log-info";
          try {
              // --- INICIO CORRECCI√ìN (Carga Inicial) ---
              const [lastMove, lastObstacle] = await Promise.all([
                  getLastMovement(),
                  getLastObstacle()
              ]);
              
              text(document.getElementById("lm-move"), lastMove?.movement_code || "‚Äî");
              text(document.getElementById("lm-speed"), lastMove?.speed_pct != null ? lastMove.speed_pct + "%" : "‚Äî");
              text(document.getElementById("lm-comment"), lastMove?.comment || "‚Äî");
              text(document.getElementById("lm-time"), lastMove?.event_time || "‚Äî");
              
              text(document.getElementById("lo-status"), lastObstacle?.status_code || "‚Äî");
              text(document.getElementById("lo-dist"), lastObstacle?.distance_cm != null ? lastObstacle.distance_cm + " cm" : "‚Äî");
              text(document.getElementById("lo-time"), lastObstacle?.event_time || "‚Äî");
              // --- FIN CORRECCI√ìN ---
              
          } catch (error) {
              console.error("Error cargando datos iniciales:", error);
              message = "‚ùå Error cargando datos iniciales";
              div.className = "log-line log-error";
          }
      }
      else if (msg.type === "new_movement") {
          // --- INICIO CORRECCI√ìN (PUSH Movimiento) ---
          message = `üöÄ MOVIMIENTO: ${msg.movement.movement_code}`;
          div.className = "log-line log-success";
          text(document.getElementById("lm-move"), msg.movement.movement_code);
          text(document.getElementById("lm-speed"), msg.movement.speed_pct + "%");
          text(document.getElementById("lm-comment"), msg.movement.comment);
          text(document.getElementById("lm-time"), msg.movement.event_time);
          // --- FIN CORRECCI√ìN ---
          
      } else if (msg.type === "new_obstacle") {
          // --- INICIO CORRECCI√ìN (PUSH Obst√°culo) ---
          message = `üöß OBST√ÅCULO: ${msg.obstacle.status_code}`;
          div.className = "log-line log-warning";
          text(document.getElementById("lo-status"), msg.obstacle.status_code);
          text(document.getElementById("lo-dist"), msg.obstacle.distance_cm + " cm");
          text(document.getElementById("lo-time"), msg.obstacle.event_time);
          // --- FIN CORRECCI√ìN ---
      } else {
          message = JSON.stringify(msg);
          div.className = "log-line log-info";
      }

      // Agregar al log
      div.innerHTML = `
          <span class="log-time">[${stamp}]</span>
          <span class="log-message">${message.replaceAll("<","&lt;").replaceAll(">","&gt;")}</span>
          <i class="fas fa-broadcast-tower ms-2"></i>
      `;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    });
    
    console.log("üîî Dashboard configurado - Solo PUSH activo");
  }

  // Cargar todo
  initWS();
  
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>