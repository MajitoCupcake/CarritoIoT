<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>IoT Car Manager · Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="assets/img/favicon.png">

    <style>
        body, html { height: 100vh; margin: 0; overflow: hidden; background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .content-area { flex-grow: 1; overflow: hidden; padding: 15px; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 400px; gap: 15px; height: 100%; }
        
        .panel { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .panel-header { padding: 12px 15px; font-weight: bold; border-bottom: 1px solid #eee; }
        .panel-body { padding: 20px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; justify-content: center; }

        .stat-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
        .stat-label { color: #7f8c8d; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        
        .log-enhanced { background: #1e1e1e; color: #00ff00; font-family: monospace; padding: 10px; font-size: 12px; height: 100%; overflow-y: auto; }
        .log-line { border-bottom: 1px solid #333; padding: 3px 0; }
        .log-time { color: #fff; font-weight: bold; margin-right: 8px; }
        .footer { background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 15px 0; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app-container">
    <nav class="navbar navbar-light bg-white border-bottom">
      <div class="container-fluid">
        <a class="navbar-brand fw-bold fs-3" href="#">
          <i class="fas fa-robot text-primary me-2"></i>IoT Car Manager
        </a>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-primary active" href="#"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
          <a class="btn btn-outline-primary" href="./control/"><i class="fas fa-gamepad me-1"></i>Control</a>
          <a class="btn btn-outline-primary" href="./monitor/"><i class="fas fa-satellite-dish me-1"></i>Monitoreo</a>
          <span id="connection-status" class="badge bg-danger ms-2">Desconectado</span>
        </div>
      </div>
    </nav>

    <div class="content-area">
        <div class="main-grid">
            <div class="panel">
                <div class="panel-header bg-primary text-white"><i class="fas fa-directions me-2"></i>Estado del Motor</div>
                <div class="panel-body text-center">
                    <div class="mb-4">
                        <div class="stat-label">Movimiento</div>
                        <div id="lm-move" class="stat-value text-primary">—</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="stat-label">Velocidad</div>
                            <div id="lm-speed" class="fs-2 fw-bold text-dark">—</div>
                        </div>
                        <div class="col-6">
                            <div class="stat-label">Hora</div>
                            <div id="lm-time" class="fs-5 text-muted mt-2">—</div>
                        </div>
                    </div>
                    <div class="alert alert-light border mt-auto"><small>Comentario:</small><br><strong id="lm-comment" class="text-secondary">—</strong></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header bg-warning text-dark"><i class="fas fa-shield-alt me-2"></i>Sensores</div>
                <div class="panel-body text-center">
                    <div class="mb-4">
                        <div class="stat-label">Estado Vía</div>
                        <div id="lo-status" class="stat-value text-success">OK</div>
                    </div>
                    <div class="mb-4">
                        <div class="stat-label">Distancia Obstáculo</div>
                        <div id="lo-dist" class="stat-value">—</div>
                    </div>
                    <div class="text-muted small">Última lectura: <span id="lo-time">—</span></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header bg-dark text-white"><i class="fas fa-terminal me-2"></i>Log del Sistema</div>
                <div class="panel-body p-0">
                    <div class="log-enhanced" id="ws-log"></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6">
            <p class="mb-0 fw-bold"><i class="fas fa-user-graduate me-2 text-primary"></i>Mary Jose Hernández Fernández</p>
            <p class="mb-0 text-muted small"><i class="fas fa-laptop-code me-2"></i>Ingeniería en Sistemas Computacionales</p>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="#" class="btn btn-sm btn-outline-primary"><i class="fab fa-linkedin me-2"></i>LinkedIn</a>
          </div>
        </div>
      </div>
    </footer>
</div>

<script>
    const HOST_IP = "18.207.21.168"; 
    const WS_PORT = "5500";
    const WS_URL = `ws://${HOST_IP}:${WS_PORT}/api/ws`; 
    const API_URL = `http://${HOST_IP}:${WS_PORT}/api`;

    function addLog(msg, type="info") {
        const log = document.getElementById("ws-log");
        const time = new Date().toLocaleTimeString();
        let color = "text-white";
        if(type==="warn") color="text-warning"; if(type==="success") color="text-success";
        log.innerHTML += `<div class="log-line"><span class="log-time">${time}</span> <span class="${color}">${msg}</span></div>`;
        log.scrollTop = log.scrollHeight;
    }

    function text(id, val) { document.getElementById(id).innerText = val || "—"; }

    function updateDashboard(move, speed, comment, time, obsStatus, obsDist, obsTime) {
        if(move) text("lm-move", move);
        if(speed) text("lm-speed", speed + "%");
        if(comment) text("lm-comment", comment);
        if(time) text("lm-time", time);
        if(obsStatus) {
            const el = document.getElementById("lo-status");
            el.innerText = obsStatus;
            el.className = obsStatus === "OBSTACULO" ? "stat-value text-danger" : "stat-value text-success";
        }
        if(obsDist) text("lo-dist", obsDist + " cm");
        if(obsTime) text("lo-time", obsTime);
    }

    async function loadInitialData() {
        try {
            const [resMove, resObs] = await Promise.all([fetch(`${API_URL}/telemetry/last-movement`), fetch(`${API_URL}/telemetry/last-obstacle`)]);
            const m = await resMove.json();
            const o = await resObs.json();
            updateDashboard(m.movement_code, m.speed_pct, m.comment, m.event_time, o.status_code, o.distance_cm, o.event_time);
        } catch(e) {}
    }

    function connectWS() {
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => { document.getElementById("connection-status").innerText = "Online"; document.getElementById("connection-status").className = "badge bg-success ms-2"; loadInitialData(); };
        ws.onclose = () => { document.getElementById("connection-status").innerText = "Offline"; document.getElementById("connection-status").className = "badge bg-danger ms-2"; setTimeout(connectWS, 3000); };
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === "new_movement") {
                addLog(`MOTOR: ${msg.movement.movement_code}`, "info");
                updateDashboard(msg.movement.movement_code, msg.movement.speed_pct, msg.movement.comment, null, null, null, null);
            } else if (msg.type === "new_obstacle") {
                addLog(`ALERTA: Obstáculo`, "warn");
                updateDashboard(null, null, null, null, msg.obstacle.status_code, msg.obstacle.distance_cm, msg.obstacle.event_time);
            }
        };
    }
    connectWS();
</script>
</body>
</html>